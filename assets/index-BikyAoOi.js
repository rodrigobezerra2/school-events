(function(){const n=document.createElement("link").relList;if(n&&n.supports&&n.supports("modulepreload"))return;for(const o of document.querySelectorAll('link[rel="modulepreload"]'))s(o);new MutationObserver(o=>{for(const c of o)if(c.type==="childList")for(const a of c.addedNodes)a.tagName==="LINK"&&a.rel==="modulepreload"&&s(a)}).observe(document,{childList:!0,subtree:!0});function t(o){const c={};return o.integrity&&(c.integrity=o.integrity),o.referrerPolicy&&(c.referrerPolicy=o.referrerPolicy),o.crossOrigin==="use-credentials"?c.credentials="include":o.crossOrigin==="anonymous"?c.credentials="omit":c.credentials="same-origin",c}function s(o){if(o.ep)return;o.ep=!0;const c=t(o);fetch(o.href,c)}})();async function x(r,n){try{const t=r.split("|");if(t.length!==4||t[0]!=="v1")throw new Error("Invalid encrypted format");const s=Uint8Array.from(atob(t[1]),d=>d.charCodeAt(0)),o=Uint8Array.from(atob(t[2]),d=>d.charCodeAt(0)),c=Uint8Array.from(atob(t[3]),d=>d.charCodeAt(0)),a=await window.crypto.subtle.importKey("raw",new TextEncoder().encode(n),"PBKDF2",!1,["deriveKey"]),i=await window.crypto.subtle.deriveKey({name:"PBKDF2",salt:s,iterations:65536,hash:"SHA-256"},a,{name:"AES-GCM",length:256},!1,["decrypt"]),f=await window.crypto.subtle.decrypt({name:"AES-GCM",iv:o},i,c),l=new TextDecoder().decode(f);return JSON.parse(l)}catch(t){throw console.error("Decryption error:",t),new Error("Incorrect password or data corruption")}}const e={overlay:document.getElementById("auth-overlay"),form:document.getElementById("auth-form"),passInput:document.getElementById("password-input"),errorMsg:document.getElementById("error-msg"),loading:document.getElementById("loading"),main:document.getElementById("main-content"),calendarGrid:document.getElementById("calendar-grid"),monthDisplay:document.getElementById("current-month-display"),prevBtn:document.getElementById("prev-month-btn"),nextBtn:document.getElementById("next-month-btn"),tableBody:document.getElementById("events-table-body"),refreshBtn:document.getElementById("refresh-btn"),logoutBtn:document.getElementById("logout-btn"),weeklyList:document.getElementById("weekly-events-list"),tabUpcoming:document.getElementById("tab-upcoming"),tabPrevious:document.getElementById("tab-previous"),yearFilter:document.getElementById("year-filter"),bulkBar:document.getElementById("bulk-actions-bar"),selectionCount:document.getElementById("selection-count"),hideBtn:document.getElementById("hide-selected-btn"),unhideBtn:document.getElementById("unhide-selected-btn"),clearBtn:document.getElementById("clear-selection-btn"),selectAllCheck:document.getElementById("select-all-checkbox"),showHiddenToggle:document.getElementById("show-hidden-toggle"),rememberMe:document.getElementById("remember-me"),legendFilters:document.querySelectorAll(".legend-item")};let v=[],y=new Date;y.setDate(1);let w="upcoming",L=localStorage.getItem("school-events-year-filter")||"All",b=new Set(JSON.parse(localStorage.getItem("school-events-hidden-ids")||"[]")),B=localStorage.getItem("school-events-show-hidden")==="true",p=JSON.parse(localStorage.getItem("school-events-filters")||'{"normal":true,"recurring":true,"halfTerm":true,"bookBag":true}'),g=new Set;e.form.addEventListener("submit",async r=>{r.preventDefault();const n=e.passInput.value;e.form.classList.add("hidden"),e.loading.classList.remove("hidden"),e.errorMsg.classList.add("hidden");try{let t;try{console.log("Fetching events.json...");let s=await fetch("./events.json");if(!s.ok&&s.status===404){if(console.warn("Private events.json not found. Falling back to mock_events.json for demo."),s=await fetch("./mock_events.json"),!s.ok)throw new Error("Could not find events.json or mock_events.json");window.isDemoMode=!0}if(!s.ok)throw console.error("Fetch failed with status:",s.status),new Error(`Data file not found (Status: ${s.status}).`);t=await s.text(),console.log("Data received (length):",t.length)}catch(s){throw console.error("Detailed Fetch Error:",s),new Error(`Could not load events: ${s.message}`)}if(t.startsWith("v1|")?v=await x(t,n):v=JSON.parse(t),console.log("Decrypted Events Data:",v.length,"items"),v.length>0&&(console.log("Sample Event Fields:",Object.keys(v[0])),console.log("Recurring Counts:",v.filter(s=>s.isRecurring||s.recurring).length)),e.rememberMe.checked){const s=Date.now()+6048e5;localStorage.setItem("school-events-saved-auth",JSON.stringify({password:n,expiry:s}))}e.yearFilter&&(e.yearFilter.value=L),e.showHiddenToggle.checked=B,C(),m(),T()}catch(t){console.error(t),e.loading.classList.add("hidden"),e.form.classList.remove("hidden"),e.errorMsg.textContent=t.message,e.errorMsg.classList.remove("hidden")}});function T(){e.overlay.classList.add("hidden"),e.main.classList.remove("hidden")}function m(){const r=A();H(r),M(r),S(r)}function A(){const r=b;let n=v;return B||(n=n.filter(t=>!r.has(t.id))),n=n.filter(t=>{const s=(t.title||"").toLowerCase(),o=t.isRecurring||t.recurring===!0;return s.includes("half term")?p.halfTerm:s.includes("book bag")?p.bookBag:o?p.recurring:p.normal}),L==="All"?n:n.filter(t=>{const s=`${t.title} ${t.notes||""}`.toLowerCase();if(L==="Reception")return s.includes("reception");const o=L;return new RegExp(`(year|yr|yrs|y)\\s*.*${o}`,"i").test(s)})}function M(r){e.weeklyList.innerHTML="";const n=new Date,t=n.getDay(),s=new Date(n);s.setDate(n.getDate()+(6-t)),s.setHours(23,59,59,999);const o=b,c=r.filter(a=>{const i=new Date(a.startDate);return i>=n&&i<=s}).sort((a,i)=>new Date(a.startDate)-new Date(i.startDate));if(c.length===0){e.weeklyList.innerHTML='<div class="empty-msg" style="font-size: 0.85rem; color: var(--color-text-secondary); text-align: center; margin-top: 1rem;">No upcoming events this week.</div>';return}c.forEach(a=>{const f=new Date(a.startDate).toLocaleDateString("en-US",{weekday:"short",month:"short",day:"numeric"}),l=document.createElement("div");l.className="event-card",o.has(a.id)&&l.classList.add("event-hidden"),l.innerHTML=`
            <div class="card-date">${f}</div>
            <h3>${a.title}</h3>
            <p>${a.notes||"No description available."}</p>
        `,l.onclick=()=>{const d=document.getElementById(`event-row-${a.id}`);d&&(d.scrollIntoView({behavior:"smooth",block:"center"}),d.classList.remove("blink-highlight"),d.offsetWidth,d.classList.add("blink-highlight"))},e.weeklyList.appendChild(l)})}function H(r){e.calendarGrid.innerHTML="";const n=y.getFullYear(),t=y.getMonth();e.monthDisplay.textContent=new Intl.DateTimeFormat("en-US",{month:"long",year:"numeric"}).format(y),["Sun","Mon","Tue","Wed","Thu","Fri","Sat"].forEach(a=>{const i=document.createElement("div");i.className="weekday-header",i.textContent=a,e.calendarGrid.appendChild(i)});const o=new Date(n,t,1).getDay(),c=new Date(n,t+1,0).getDate();for(let a=0;a<o;a++){const i=document.createElement("div");i.className="calendar-day other-month",e.calendarGrid.appendChild(i)}for(let a=1;a<=c;a++){const i=document.createElement("div");i.className="calendar-day",i.textContent=a,`${n}${String(t+1).padStart(2,"0")}${String(a).padStart(2,"0")}`;const f=new Date(n,t,a);f.setHours(0,0,0,0);const l=r.filter(d=>{const u=new Date(d.startDate);if(u.setHours(0,0,0,0),d.endDate){const h=new Date(d.endDate);return h.setHours(23,59,59,999),f>=u&&f<=h}return f.getTime()===u.getTime()});if(l.length>0){i.classList.add("has-events");const d=document.createElement("div");d.className="dots-container",l.forEach(u=>{const h=document.createElement("div");h.className="event-dot";const k=(u.title||"").toLowerCase(),D=u.isRecurring||u.recurring===!0;k.includes("half term")?h.classList.add("half-term"):k.includes("book bag")?h.classList.add("book-bag"):D&&h.classList.add("recurring"),b.has(u.id)&&(h.style.opacity="0.3"),d.appendChild(h)}),i.appendChild(d),i.title=l.map(u=>u.title).join(`
`),i.onclick=()=>{const u=l[0],h=new Date(u.startDate),k=new Date;k.setHours(0,0,0,0);const D=h>=k?"upcoming":"previous";w!==D&&(w=D,w==="upcoming"?(e.tabUpcoming.classList.add("active"),e.tabPrevious.classList.remove("active")):(e.tabPrevious.classList.add("active"),e.tabUpcoming.classList.remove("active")),S(r));const E=document.getElementById(`event-row-${u.id}`);E&&(E.scrollIntoView({behavior:"smooth",block:"center"}),E.classList.remove("blink-highlight"),E.offsetWidth,E.classList.add("blink-highlight"))}}N(n,t,a)&&i.classList.add("today"),e.calendarGrid.appendChild(i)}}function S(r){e.tableBody.innerHTML="";const n=new Date;n.setHours(0,0,0,0);let t;w==="upcoming"?t=r.filter(o=>new Date(o.startDate)>=n):t=r.filter(o=>new Date(o.startDate)<n);const s=[...t].sort((o,c)=>{const a=new Date(o.startDate)-new Date(c.startDate);return w==="upcoming"?a:-a});if(s.length===0){e.tableBody.innerHTML=`<tr><td colspan="4" style="text-align: center; padding: 2rem; color: var(--color-text-secondary);">No ${w} events found.</td></tr>`;return}s.forEach(o=>{const a=new Date(o.startDate).toLocaleDateString("en-US",{weekday:"short",month:"short",day:"numeric"});let i=o.sourceEmailSubject||"N/A";i.startsWith("Fwd: ")&&(i=i.substring(5));const f=o.sourceEmailReceivedAt?new Date(o.sourceEmailReceivedAt).toLocaleString("en-US",{month:"short",day:"numeric",hour:"2-digit",minute:"2-digit"}):"N/A",l=document.createElement("tr");l.id=`event-row-${o.id}`,b.has(o.id)&&l.classList.add("event-hidden");const u=g.has(o.id),k=o.isRecurring||o.recurring===!0?`
            <svg class="recurring-icon" viewBox="0 0 24 24" title="Recurring Event">
                <path d="M 20 12 A 8 8 0 1 1 12 4" fill="none" stroke="currentColor" stroke-width="2.5" stroke-linecap="round"/>
                <polyline points="17,15 20,12 23,15" fill="none" stroke="currentColor" stroke-width="2.5" stroke-linecap="round" stroke-linejoin="round"/>
            </svg>`:"";l.innerHTML=`
            <td><input type="checkbox" class="event-checkbox" data-id="${o.id}" ${u?"checked":""}></td>
            <td class="date-cell">${a}</td>
            <td>${k}<strong>${o.title}</strong></td>
            <td>
                <div style="font-size: 0.8rem; font-weight: 600;">${i}</div>
                <div style="font-size: 0.7rem; color: var(--color-text-secondary);">${f}</div>
            </td>
            <td><span class="event-notes">${o.notes||""}</span></td>
        `,l.querySelector(".event-checkbox").addEventListener("change",E=>{E.target.checked?g.add(o.id):(g.delete(o.id),e.selectAllCheck.checked=!1),I()}),e.tableBody.appendChild(l)})}function I(){const r=g.size;if(r>0){e.bulkBar.classList.remove("hidden"),e.selectionCount.textContent=`${r} item${r>1?"s":""} selected`;const n=[...g].filter(t=>b.has(t)).length;n>0?e.unhideBtn.classList.remove("hidden"):e.unhideBtn.classList.add("hidden"),n<r?e.hideBtn.classList.remove("hidden"):e.hideBtn.classList.add("hidden")}else e.bulkBar.classList.add("hidden"),e.selectAllCheck.checked=!1}function N(r,n,t){const s=new Date;return s.getFullYear()===r&&s.getMonth()===n&&s.getDate()===t}e.prevBtn.addEventListener("click",()=>{y.setDate(1),y.setMonth(y.getMonth()-1),m()});e.nextBtn.addEventListener("click",()=>{y.setDate(1),y.setMonth(y.getMonth()+1),m()});e.tabUpcoming.addEventListener("click",()=>{w="upcoming",e.tabUpcoming.classList.add("active"),e.tabPrevious.classList.remove("active"),m()});e.tabPrevious.addEventListener("click",()=>{w="previous",e.tabPrevious.classList.add("active"),e.tabUpcoming.classList.remove("active"),m()});e.refreshBtn.addEventListener("click",()=>location.reload());e.logoutBtn.addEventListener("click",()=>{localStorage.removeItem("school-events-saved-auth"),location.reload()});e.yearFilter&&e.yearFilter.addEventListener("change",r=>{L=r.target.value,localStorage.setItem("school-events-year-filter",L),m()});e.showHiddenToggle.addEventListener("change",r=>{B=r.target.checked,localStorage.setItem("school-events-show-hidden",B),m()});e.legendFilters.forEach(r=>{r.addEventListener("click",()=>{const n=r.dataset.category,t=n==="half-term"?"halfTerm":n==="book-bag"?"bookBag":n;p[t]=!p[t],console.log(`Toggled ${t}:`,p[t]),localStorage.setItem("school-events-filters",JSON.stringify(p)),C(),m()})});function C(){e.legendFilters.forEach(r=>{const n=r.dataset.category;p[n==="half-term"?"halfTerm":n==="book-bag"?"bookBag":n]?r.classList.remove("inactive"):r.classList.add("inactive")})}e.selectAllCheck.addEventListener("change",r=>{const n=A(),t=new Date;t.setHours(0,0,0,0);const s=w==="upcoming"?n.filter(o=>new Date(o.startDate)>=t):n.filter(o=>new Date(o.startDate)<t);r.target.checked?s.forEach(o=>g.add(o.id)):g.clear(),S(n),I()});e.clearBtn.addEventListener("click",()=>{g.clear(),e.selectAllCheck.checked=!1,m(),I()});e.hideBtn.addEventListener("click",()=>{g.forEach(r=>b.add(r)),$(),F()});e.unhideBtn.addEventListener("click",()=>{g.forEach(r=>b.delete(r)),$(),F()});function $(){localStorage.setItem("school-events-hidden-ids",JSON.stringify([...b]))}function F(){g.clear(),e.selectAllCheck.checked=!1,m(),I()}document.querySelector(".logo").addEventListener("dblclick",()=>{confirm("Reset all hidden events?")&&(b.clear(),localStorage.removeItem("school-events-hidden-ids"),m())});async function O(){const r=JSON.parse(localStorage.getItem("school-events-saved-auth"));if(r){if(Date.now()>r.expiry){localStorage.removeItem("school-events-saved-auth");return}try{e.overlay.classList.add("hidden"),e.loading.classList.remove("hidden"),console.log("Attempting auto-login...");const n=await fetch("./events.json");if(!n.ok)throw new Error(`Fetch failed: ${n.status}`);const t=await n.text();t.startsWith("v1|")?v=await x(t,r.password):v=JSON.parse(t),e.yearFilter&&(e.yearFilter.value=L),e.showHiddenToggle.checked=B,C(),m(),T()}catch(n){console.warn("Auto-login failed:",n),localStorage.removeItem("school-events-saved-auth"),e.overlay.classList.remove("hidden"),e.loading.classList.add("hidden"),e.form.classList.remove("hidden")}}}O();
